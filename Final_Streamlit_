import pandas as pd
import streamlit as st
import matplotlib.pyplot as plt
import seaborn as sns
from PIL import Image
import matplotlib

# í•œê¸€ í°íŠ¸ ì„¤ì • (ìœˆë„ìš°ì—ì„œ 'ë§‘ì€ ê³ ë”•' ì‚¬ìš©)
matplotlib.rcParams['font.family'] = 'Malgun Gothic'

# íŒŒì¼ ë¡œë“œ
data = pd.read_csv(r'C:/Users/Admin/Desktop/Final_Project/merged_data_with_fileID.csv')

# REBA ìŠ¤ì½”ì–´ì™€ ê°ë„ì— ë”°ë¥¸ ìì„¸ í‰ê°€ í•¨ìˆ˜
def evaluate_posture(row):
    trunk_angle = row['trunk_angle']
    reba_score = row['final_reba_score']
    
    if trunk_angle >= 90 and reba_score >= 7:
        return 'High Risk: Possible Lower Back Pain'
    elif reba_score >= 7:
        return 'Moderate Risk: Consider Posture Adjustment'
    else:
        return 'Safe: Good Posture'

# ê° ì‘ì—…ìì˜ ìì„¸ í‰ê°€ ê²°ê³¼ ì¶”ê°€
data['posture_alert'] = data.apply(evaluate_posture, axis=1)

# Streamlit ëŒ€ì‹œë³´ë“œ ì œëª©
st.title("ì‘ì—…ì ê±´ê°• ëª¨ë‹ˆí„°ë§ ë³´ê³ ì„œ")

# ì„œë¸Œ ì œëª©
st.subheader("ê·¼ë¡œìì˜ ì‘ì—… ìì„¸ ë¶„ì„ ë° ê°œì„  ë°©ì•ˆ ì œê³µ")

# 1) ì‘ì—…ìì˜ ì¢‹ì§€ ì•Šì€ ìì„¸ë¥¼ ë³´ì—¬ì£¼ëŠ” ì‚¬ì§„
st.markdown("### ğŸš¨ ì‘ì—…ìì˜ ì¢‹ì§€ ì•Šì€ ìì„¸ ì‚¬ì§„")
image_path = r'C:/Users/Admin/Desktop/Final_Project/Sample/Sample/1.ì›ì²œë°ì´í„°/F05_P001_A2_W001_D2022-09-23-10-04-45_0254.jpg'  # ì‹¤ì œ ê²½ë¡œë¡œ ìˆ˜ì •

# PILì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ì—´ê¸°
try:
    image = Image.open(image_path)  # PILì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ì—´ê¸°
    st.image(image, caption="ì‘ì—…ìì˜ ìì„¸ ë¶„ì„", use_container_width=True)  # Streamlitì— ì´ë¯¸ì§€ í‘œì‹œ
except Exception as e:
    st.error(f"ì´ë¯¸ì§€ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²½ë¡œ: {image_path}ê°€ ì •í™•í•œì§€ í™•ì¸í•´ ì£¼ì„¸ìš”. ì˜¤ë¥˜: {e}")

# 2) ì´ë¡œ ì¸í•´ ë¶€ë‹´ë  ìˆ˜ ìˆëŠ” ê´€ì ˆ
st.markdown("### ğŸ’ª ì´ë¡œ ì¸í•´ ë¶€ë‹´ë  ìˆ˜ ìˆëŠ” ê´€ì ˆ")
angles = ['trunk_angle', 'neck_angle', 'shoulder_angle', 'elbow_angle', 'wrist_angle']
angle_values = [data.iloc[0][angle] for angle in angles]

fig, ax = plt.subplots(figsize=(10, 6))
ax.bar(angles, angle_values, color='orange')
ax.set_xlabel('ê´€ì ˆ ë¶€ìœ„')
ax.set_ylabel('ê°ë„ (ë„)')
ax.set_title('ê´€ì ˆ ë¶€ë‹´ ê°ë„')
st.pyplot(fig)

# 3) ê³¼ë„í•œ í˜ì„ ì“°ëŠ” ë¶€ìœ„ (íˆíŠ¸ë§µ ë˜ëŠ” ë°”ì°¨íŠ¸)
st.markdown("### ğŸ’¥ ê³¼ë„í•œ í˜ì„ ì“°ëŠ” ë¶€ìœ„")
muscle_areas = ['Neck', 'Back', 'Legs', 'Arms', 'Shoulders']
energy_usage = [80, 60, 50, 40, 30]
plt.figure(figsize=(10, 6))
sns.barplot(x=muscle_areas, y=energy_usage, palette='viridis')
plt.xlabel('ê·¼ìœ¡ ë¶€ìœ„')
plt.ylabel('ì—ë„ˆì§€ ì‚¬ìš©ëŸ‰')
plt.title('ê³¼ë„í•œ í˜ì„ ì“°ëŠ” ë¶€ìœ„')
st.pyplot(plt)

# 4) ëŒ€ì²´ ê°€ëŠ¥í•œ ì‘ì—… ìì„¸ ì œì‹œì™€ ê·¼ê´€ì ˆ ê±´ê°•ì— ë„ì›€ì´ ë˜ëŠ” ìš´ë™ì„ ì˜†ì— ë°°ì¹˜
col1, col2 = st.columns(2)  # 2ê°œì˜ ì»¬ëŸ¼ ìƒì„±

with col1:
    st.markdown("### ğŸ”„ ëŒ€ì²´ ê°€ëŠ¥í•œ ì‘ì—… ìì„¸ ì œì‹œ")
    # ëŒ€ì²´ ìì„¸ ì•„ì´ì½˜ ë˜ëŠ” ì´ë¯¸ì§€ (íŒŒì¼ ê²½ë¡œ ìˆ˜ì •)
    alternative_posture_image = r'C:/Users/Admin/Desktop/Final_Project/alternative_posture.png'  # ê²½ë¡œ ìˆ˜ì •
    st.image(alternative_posture_image, caption="ëŒ€ì²´ ì‘ì—… ìì„¸", use_container_width=True)  # use_container_widthë¡œ ë³€ê²½

with col2:
    st.markdown("### ğŸ‹ï¸â€â™‚ï¸ ê·¼ê´€ì ˆ ê±´ê°•ì— ë„ì›€ì´ ë˜ëŠ” ìš´ë™")
    # ìš´ë™ ì•„ì´ì½˜ ë˜ëŠ” ì´ë¯¸ì§€ (íŒŒì¼ ê²½ë¡œ ìˆ˜ì •)
    exercise_image = r'C:/Users/Admin/Desktop/Final_Project/exercise_icon.png'  # ê²½ë¡œ ìˆ˜ì •
    st.image(exercise_image, caption="ê·¼ê´€ì ˆ ê±´ê°• ìš´ë™", use_container_width=True)  # use_container_widthë¡œ ë³€ê²½

# ê° ì‘ì—…ìì˜ ì•Œë¦¼ (ì‘ì—…ìë³„ ì•Œë¦¼ ìš”ì•½)
# ì‘ì—…ì ìƒíƒœ ìš”ì•½
high_risk_workers = data[data['posture_alert'] == 'High Risk: Possible Lower Back Pain']
moderate_risk_workers = data[data['posture_alert'] == 'Moderate Risk: Consider Posture Adjustment']

# ì•Œë¦¼ì„ í•œ ë²ˆë§Œ ë„ìš°ë„ë¡ ì²˜ë¦¬
alerted_workers = set()  # ì´ë¯¸ ì•Œë¦¼ì„ ë°›ì€ ì‘ì—…ì

# ê³ ìœ„í—˜ ì‘ì—…ì ìš”ì•½
st.markdown(f"### âš ï¸ ê³ ìœ„í—˜ ìƒíƒœì¸ ì‘ì—…ì: {len(high_risk_workers)}ëª…")
for _, row in high_risk_workers.iterrows():
    worker_id = row['fileID']
    
    # ì´ë¯¸ ì•Œë¦¼ì„ ë„ìš´ ì‘ì—…ìëŠ” ì œì™¸
    if worker_id not in alerted_workers:
        st.warning(f"ì‘ì—…ì {worker_id}ëŠ” í—ˆë¦¬ í†µì¦ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤.")
        alerted_workers.add(worker_id)

# ì£¼ì˜ê°€ í•„ìš”í•œ ì‘ì—…ì ìš”ì•½
st.markdown(f"### âš ï¸ ì£¼ì˜ê°€ í•„ìš”í•œ ì‘ì—…ì: {len(moderate_risk_workers)}ëª…")
for _, row in moderate_risk_workers.iterrows():
    worker_id = row['fileID']
    
    # ì´ë¯¸ ì•Œë¦¼ì„ ë„ìš´ ì‘ì—…ìëŠ” ì œì™¸
    if worker_id not in alerted_workers:
        st.info(f"ì‘ì—…ì {worker_id}ëŠ” ìì„¸ê°€ ì¢‹ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        alerted_workers.add(worker_id)

